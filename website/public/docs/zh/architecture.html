<style>
.arch-flow-container {
  overflow-x: auto;
  padding: 2rem 0;
  margin: 2rem 0;
}
.arch-flow {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  min-width: 1100px;
}
.arch-box {
  background: rgba(30, 30, 40, 0.8);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(100, 100, 120, 0.4);
  border-radius: 12px;
  padding: 1rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
}
.arch-box-inner {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.arch-icon {
  width: 48px;
  height: 48px;
  border-radius: 8px;
  border: 1px solid rgba(100, 100, 120, 0.5);
  background: rgba(50, 50, 60, 0.2);
  display: flex;
  align-items: center;
  justify-content: center;
}
.arch-icon svg {
  color: #888;
}
.arch-title {
  font-size: 0.875rem;
  font-weight: 600;
  color: #888;
}
.arch-subtitle {
  font-size: 0.75rem;
  font-family: monospace;
  color: #666;
}
.arch-arrow {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.arch-line {
  width: 48px;
  height: 2px;
  background: #444;
}
.arch-arrow svg {
  color: #666;
}
.blue-theme .arch-icon { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); }
.blue-theme .arch-icon svg { color: #60a5fa; }
.blue-theme .arch-title { color: #60a5fa; }
.orange-theme .arch-icon { background: rgba(251, 146, 60, 0.2); border-color: rgba(251, 146, 60, 0.5); }
.orange-theme .arch-icon svg { color: #fb923c; }
.orange-theme .arch-title { color: #fb923c; }
.purple-theme .arch-icon { background: rgba(168, 85, 247, 0.2); border-color: rgba(168, 85, 247, 0.5); }
.purple-theme .arch-icon svg { color: #a78bfa; }
.purple-theme .arch-title { color: #a78bfa; }
.emerald-theme .arch-icon { background: rgba(52, 211, 153, 0.2); border-color: rgba(52, 211, 153, 0.5); }
.emerald-theme .arch-icon svg { color: #34d399; }
.emerald-theme .arch-title { color: #34d399; }
</style>

<h1>架构</h1>

<p>WebMCP Adapter 采用<strong>独立服务架构</strong>,将 WebSocket 桥接与 Claude Desktop 的进程生命周期解耦。</p>

<h2>系统组件</h2>

<div class="arch-flow-container">
  <div class="arch-flow">
    <!-- AI Client -->
    <div class="arch-box blue-theme">
      <div class="arch-box-inner">
        <div class="arch-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
          </svg>
        </div>
        <div>
          <div class="arch-title">AI 客户端</div>
          <div class="arch-subtitle">Claude Desktop</div>
        </div>
      </div>
    </div>

    <div class="arch-arrow">
      <div class="arch-line"></div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7" />
      </svg>
    </div>

    <!-- MCP Server -->
    <div class="arch-box orange-theme">
      <div class="arch-box-inner">
        <div class="arch-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="2" y="3" width="20" height="14" rx="2" />
            <path d="M8 21h8M12 17v4" />
          </svg>
        </div>
        <div>
          <div class="arch-title">MCP 服务器</div>
          <div class="arch-subtitle">native-host/mcp-server.js</div>
        </div>
      </div>
    </div>

    <div class="arch-arrow">
      <div class="arch-line"></div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7" />
      </svg>
    </div>

    <!-- WebSocket Bridge -->
    <div class="arch-box purple-theme">
      <div class="arch-box-inner">
        <div class="arch-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M18 20V10M12 20V4M6 20v-6" />
          </svg>
        </div>
        <div>
          <div class="arch-title">WebSocket 服务</div>
          <div class="arch-subtitle">localhost:3711</div>
        </div>
      </div>
    </div>

    <div class="arch-arrow">
      <div class="arch-line"></div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M5 12h14M12 5l7 7-7 7" />
      </svg>
    </div>

    <!-- Browser Extension -->
    <div class="arch-box emerald-theme">
      <div class="arch-box-inner">
        <div class="arch-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <path d="M3 9h18M9 21V9" />
          </svg>
        </div>
        <div>
          <div class="arch-title">浏览器扩展</div>
          <div class="arch-subtitle">Chrome 扩展</div>
        </div>
      </div>
    </div>
  </div>
</div>

<h2>组件职责</h2>

<h3>MCP 服务器（<code>native-host/mcp-server.js</code>）</h3>

<p><strong>角色：</strong>Claude Desktop 与 WebSocket 服务之间的协议转换器。</p>

<p><strong>核心职责：</strong></p>
<ul>
<li>实现 Model Context Protocol (MCP) 规范</li>
<li>配置 MCP 服务器后，由 Claude Desktop 通过 stdio 自动启动</li>
<li>通过 <code>tools/list</code> 端点向 Claude 暴露已发现的工具</li>
<li>接收 Claude 的工具调用请求并转发给 WebSocket 服务</li>
<li>将工具执行结果返回给 Claude</li>
<li>本身不维护任何工具状态——充当无状态代理</li>
</ul>

<p><strong>生命周期：</strong>Claude Desktop 启动时启动，Claude 关闭时终止。每个 Claude 会话获得一个全新的 MCP 服务器实例。</p>

<h3>WebSocket 服务（<code>native-host/bridge.js</code>）</h3>

<p><strong>角色：</strong>中央消息路由器和工具注册中心。</p>

<p><strong>核心职责：</strong></p>
<ul>
<li>作为独立后台进程运行在 <code>localhost:3711</code></li>
<li>维护所有可用工具的实时注册表，按浏览器 Tab ID 索引</li>
<li>接受来自 MCP 服务器和浏览器扩展的 WebSocket 连接</li>
<li>将 MCP 服务器的工具调用请求路由到正确的浏览器 Tab</li>
<li>向所有已连接的 MCP 客户端广播工具注册更新</li>
<li>处理 Tab 生命周期事件（Tab 关闭 → 移除工具，Tab 打开 → 注册工具）</li>
</ul>

<p><strong>生命周期：</strong>长期运行的守护进程。在 Claude Desktop 重启后仍然存活。使用 <code>node index.js --service</code> 启动一次后持续在后台运行。</p>

<p><strong>为什么独立？</strong>将服务与 Claude 的生命周期解耦，确保工具注册表在 Claude 会话之间持久化。当 Claude 重启时，它会重新连接到现有服务并立即看到所有已注册的工具。</p>

<h3>浏览器扩展（<code>extension/</code>）</h3>

<p><strong>角色：</strong>WebSocket 服务与网页之间的桥梁。</p>

<p><strong>核心职责：</strong></p>
<ul>
<li><strong>Service Worker</strong>（<code>background/service-worker.js</code>）：
  <ul>
    <li>维护到 <code>localhost:3711</code> 的 WebSocket 连接</li>
    <li>接收来自 content script 的工具注册并转发给服务</li>
    <li>接收来自服务的工具调用请求并分发到正确的 Tab</li>
    <li>管理从 Hub 注册表安装和更新 adapter</li>
  </ul>
</li>
<li><strong>Content Script</strong>（<code>content/injector.js</code>）：
  <ul>
    <li>注入到每个网页中</li>
    <li>检测当前页面 URL 并加载匹配的 adapter</li>
    <li>为 adapter 暴露 <code>window.__webmcpRegister()</code> API 以注册工具</li>
    <li>将工具调用分发给 adapter 的 handler 函数</li>
    <li>将执行结果返回给 service worker</li>
  </ul>
</li>
</ul>

<p><strong>安全性：</strong>Content script 运行在隔离环境中，与页面的 JavaScript 上下文分离。Adapter 可以访问 DOM，但不能干扰页面脚本。</p>

<h3>Adapter（<code>extension/adapters/*.js</code>）</h3>

<p><strong>角色：</strong>特定网站的工具实现。</p>

<p><strong>核心职责：</strong></p>
<ul>
<li>检测到匹配的 URL 时动态加载（例如，<code>mail.163.com.js</code> 用于 163 邮箱）</li>
<li>调用 <code>window.__webmcpRegister(namespace, tools)</code> 声明可用工具</li>
<li>每个工具指定：
  <ul>
    <li><code>name</code>：工具标识符（例如 <code>search_emails</code>）</li>
    <li><code>description</code>：工具功能描述</li>
    <li><code>inputSchema</code>：参数的 JSON Schema</li>
    <li><code>handler</code>：执行实际 DOM 操作的异步函数</li>
  </ul>
</li>
<li>Handler 使用标准 DOM API（<code>querySelector</code>、<code>click</code>、<code>value</code> 等）与页面交互</li>
<li>返回结构化结果（成功/错误、数据负载）给调用者</li>
</ul>

<p><strong>示例：</strong>Gmail adapter 提供 <code>search_emails</code>、<code>open_email</code>、<code>compose_email</code> 等工具——每个都实现为操作 Gmail DOM 的 handler 函数。</p>

<h2>消息流示例</h2>

<p>当 Claude 调用工具时（例如"搜索关于发票的邮件"）：</p>

<ol>
<li><strong>Claude Desktop</strong> → 向 MCP 服务器发送 MCP <code>tools/call</code> 请求</li>
<li><strong>MCP 服务器</strong> → 通过 WebSocket 将请求转发给 WebSocket 服务</li>
<li><strong>WebSocket 服务</strong> → 查找哪个 Tab 拥有该工具，将请求路由到浏览器扩展</li>
<li><strong>浏览器扩展</strong> → 分发到正确 Tab 的 content script</li>
<li><strong>Content Script</strong> → 调用 adapter 的 handler 函数</li>
<li><strong>Adapter</strong> → 操作 DOM（在搜索框中输入、点击搜索按钮、提取结果）</li>
<li><strong>结果反向流回</strong>通过相同的链路</li>
<li><strong>Claude Desktop</strong> → 接收搜索结果并继续对话</li>
</ol>

<h2>端口与安全</h2>

<p>WebSocket 服务仅在 <code>localhost:3711</code> 上监听，不对外网开放。所有通信都在本机内完成。</p>

<h2>下一步</h2>

<ul>
<li><a href="/docs/how-it-works">工作原理</a> — 工具注册和调用的详细消息流</li>
<li><a href="/docs/adapter-system">Adapter 体系</a> — adapter 如何加载和沙箱隔离</li>
<li><a href="/docs/writing-an-adapter">编写 Adapter</a> — 创建你自己的网站 adapter</li>
</ul>
